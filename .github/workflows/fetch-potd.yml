name: Fetch Picture of the Day

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  fetch-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate current picture number
        id: calc
        run: |
          # Calculate days since start date
          START_DATE="2024-11-26"
          CURRENT_DATE=$(date +%Y-%m-%d)

          # Convert dates to seconds and calculate difference
          START_SECONDS=$(date -d "$START_DATE" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "$START_DATE" +%s)
          CURRENT_SECONDS=$(date -d "$CURRENT_DATE" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "$CURRENT_DATE" +%s)

          DAYS_DIFF=$(( ($CURRENT_SECONDS - $START_SECONDS) / 86400 ))

          # Calculate picture number (1-based, cycles through available pictures)
          # Assuming 100 pictures max, adjust as needed
          PICTURE_NUM=$(( ($DAYS_DIFF % 100) + 1 ))

          echo "picture_num=$PICTURE_NUM" >> $GITHUB_OUTPUT
          echo "Current picture number: $PICTURE_NUM"

      - name: Checkout private pictures repo
        uses: actions/checkout@v6
        with:
          repository: Ghostavio/potd-images # Replace with your private repo name
          token: ${{ secrets.POTD_REPO_TOKEN }} # You'll need to create this secret
          path: private-images

      - name: Copy current picture
        run: |
          PICTURE_NUM=${{ steps.calc.outputs.picture_num }}

          # Copy the current picture to the public assets folder
          if [ -f "private-images/$PICTURE_NUM.avif" ]; then
            cp "private-images/$PICTURE_NUM.avif" "assets/images/potd/current.avif"
            echo "✅ Copied picture $PICTURE_NUM"
          else
            echo "⚠️  Picture $PICTURE_NUM.avif not found, keeping existing"
          fi

      - name: Commit and push if changed
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          if git diff --quiet assets/images/potd/; then
            echo "No changes to commit"
          else
            git add assets/images/potd/current.avif
            git commit -m "Update Picture of the Day"
            git push
          fi
